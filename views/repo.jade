extends layout

append head
  title #{kind}/#{proj} - #{users.join('-')} - Didit

append scripts
  if authstaff
    script.
      $('#build').click(function() {
        $.post('/build/#{kind}/#{proj}/#{users.join('-')}/#{head}').done(function(data) {
          $('#build-output').text(data);
        }).fail(function(req) {
          $('#build-output').text(req.responseText);
        });
        $('#build-progress').modal('show');
      });

block content
  div.span3
    include sidebar
  div.span9
    div.page-header
      h1
        tt #{kind}/#{proj}
        |  by&nbsp;
        tt= users.join('-')
      if gitweb
        p: a(href=gitweb(locals)) view repository on gitweb

    if head || current
      
      if authstaff
        div#confirm-build.modal.hide.form-horizontal(tabindex='-1')
          div.modal-header
            a.close(data-dismiss='modal') &times;
            h3 Confirm build
          div.modal-body
            p Request a build for this project.
            p If a build is already scheduled or was already completed for this revision,
              br
              | a new build will not be started.
          div.modal-footer
            a.btn(href='#', data-dismiss='modal') Cancel
            button#build.btn.btn-info(data-dismiss='modal') Build #{users.join('-')}@
              tt= head
        
        div#build-progress.modal.hide.modal-bottom(data-backdrop='', tabindex='-1')
          div.modal-header
            a.close(data-dismiss='modal') &times;
            h3 Build progress
          div.modal-body
            pre#build-output Build requested...
      
      div.span6.pull-right.well
        h2= head ? 'Latest revision' : 'Latest build'
        if current
          h3
            a(href="/#{current.spec.kind}/#{current.spec.proj}/#{current.spec.users.join('-')}/#{current.spec.rev}")
              tt= current.spec.rev
            | &nbsp;
            small built #{locals.moment(current.finished).calendar()}
          div.alert(class="alert-#{current.public ? 'success' : 'yellow'}")
            h4 Public tests #{current.public ? 'passed' : 'FAILED'}
          div.alert(class="alert-#{current.compile ? 'success' : 'error'}")
            h4 Compilation #{current.compile ? 'succeeded' : 'FAILED'}
        else
          h3
            tt.muted= head
            | &nbsp;
            small no build completed
          if authstaff && staffmode
            a.btn.btn-mini(href='#confirm-build', data-toggle='modal') build

    if milestones
      - milestones = milestones.filter(function(m) { return m.released || (authstaff && staffmode); });
      if milestones.length > 0
        div.span6.pull-right.well
          h2 Milestones
          each milestone in milestones
            h3
              a(class="#{milestone.released ? '' : 'text-warning'}",
                href="/milestone/#{kind}/#{proj}/#{users.join('-')}/#{milestone.name}")= milestone.name

    h2= builds.length > 0 ? 'Builds' : 'No builds'
    each build in builds
      h3: a(href="/#{build.kind}/#{build.proj}/#{build.users.join('-')}/#{build.rev}"): tt= build.rev
