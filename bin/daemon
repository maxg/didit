#!/bin/bash

#
# Daemon start/stop script.
#

cmd="$1"
script="$2"

export NODE_ENV=production

if [[ "$EUID" -ne 0 ]]; then
  echo "$0 requires root"
fi

if [[ -z "$cmd" ]]; then
  echo "Usage: sudo $0 <cmd> [<script>]"
  exit 1
fi

dir=$(cd `dirname "$script"` && pwd)

case "$cmd" in
  start)
    if [[ -z "$script" ]]; then
      echo "Usage: $cmd requires <script>"
      exit 1
    fi
    # start-stop-daemon -> k5start -> authbind -> forever wrapper
    # only runs if user didit is not already running k5start
    start-stop-daemon -v --start --chuid didit --user didit --exec \
      /usr/bin/k5start -- -b -L -f /etc/didit.keytab -t -U -- \
      authbind --depth 4 \
      "$dir/bin/forever" "$script"
    ;;
  stop)
    # kills ALL node processes owned by user didit
    start-stop-daemon -v --stop --user didit --name node
    ;;
  *)
    echo "Usage: commands are {start,stop}"
    ;;
esac
